<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Event Calendar</h1>
    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: '/calendar/events/json/',  // Updated path for fetching JSON data
                
                // Allow users to add events
                selectable: true,
                select: function(info) {
                    var title = prompt('Enter event title:');
                    if (title) {
                        $.ajax({
                            url: '/calendar/events/add/',  // Updated path for adding events
                            method: 'POST',
                            data: {
                                title: title,
                                start: info.startStr,
                                end: info.endStr,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function() {
                                calendar.refetchEvents();  // Refresh the events on the calendar
                            },
                            error: function() {
                                alert('There was an error adding the event.');
                            }
                        });
                    }
                },

                // Allow users to edit events by dragging and resizing
                editable: true,
                eventDrop: function(info) {
                    $.ajax({
                        url: '/calendar/events/edit/' + info.event.id + '/',  // Updated path for editing events
                        method: 'POST',
                        data: {
                            title: info.event.title,
                            start: info.event.start.toISOString(),
                            end: info.event.end ? info.event.end.toISOString() : null,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function() {
                            calendar.refetchEvents();
                        },
                        error: function() {
                            alert('There was an error updating the event.');
                        }
                    });
                },
                eventResize: function(info) {
                    $.ajax({
                        url: '/calendar/events/edit/' + info.event.id + '/',  // Updated path for editing events
                        method: 'POST',
                        data: {
                            title: info.event.title,
                            start: info.event.start.toISOString(),
                            end: info.event.end.toISOString(),
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function() {
                            calendar.refetchEvents();
                        },
                        error: function() {
                            alert('There was an error updating the event.');
                        }
                    });
                },

                // Allow users to delete events by clicking them
                eventClick: function(info) {
                    if (confirm('Do you want to delete this event?')) {
                        $.ajax({
                            url: '/calendar/events/delete/' + info.event.id + '/',  // Correct event ID is now passed
                            method: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function() {
                                calendar.refetchEvents();
                            },
                            error: function() {
                                alert('There was an error deleting the event.');
                            }
                        });
                    }
                }
            });

            calendar.render();
        });
    </script>
</body>
</html>
